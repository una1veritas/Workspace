# Copilot / AI Agent 指示書

このリポジトリは主に6502系アセンブリと小さなCランタイム用のROMイメージを生成するためのビルドスクリプト群です。AIエージェントが素早く作業に取りかかれるよう、プロジェクト固有の重要事項と具体的な例をまとめます。

**クイックビルド**:
- ルートで単純にビルド: `make`（`ehbasic.bin basic2.bin wozmon.bin` を生成）
- 個別ターゲット例: `make ehbasic.bin` / `make wozmon.bin` / `make rom_basic2`

**必須ツールチェイン**:
- `ca65`, `cl65`, `ld65`（cc65 ツールチェイン）
- `srec_cat`（バイナリ→C配列変換に使用）
- `bintomon`（`.bin`→`.mon`表記に変換、Makefileのターゲット参照）

（Makefileを直接参照してください。例: `ca65 -g -l min_mon.lst --feature labels_without_colons -o ehbasic.o min_mon.asm`）

**主要ファイルと役割（抜粋）**:
- `min_mon.asm` / `min_mon.lst` — 小さなモニタ/ブート周りの共通コード。`ehbasic.o` の組み立てに使われます。
- `basic2.asm`, `mos.asm` — BASICランタイム周りのソース。
- `wozmon.asm`, `wozmon.lst` — WOZモニタの実装と一覧。
- `rom_*.c`, `rom.c`, `rom_basic2.c` — `srec_cat` で生成されるC配列（ROM埋め込み用）。
- `2carray.py` — 小さなユーティリティ（リポジトリにあり、参考にすること）。

**コードパターン／プロジェクト固有の慣習**:
- アセンブリは `ca65` に `-g -l <list>` を渡してリスト (`.lst`) を生成します。デバッグや差分確認は `.lst` を参照してください。
- `--feature labels_without_colons` オプションが頻用されるため、ラベル文法でコロンを省略するスタイルが混在しています。
- ビルドはアセンブル→`cl65`/`ld65` でリンク→必要に応じて `srec_cat` でC配列に変換、という一連の流れです。
- バイナリ検査や配列化は Makefile の `rom_*` ターゲットを通じて行うのが既存ワークフローです。

**変更を加える際のチェックリスト（短い手順）**:
1. 変更箇所の `.org`（実行先アドレス）がソースと一致するか確認する。
2. `ca65` のアセンブルオプション（特に `--feature`）を保つ。
3. `make` でビルドし、対応する `.lst` を差分で確認する（シンボル/アドレスずれの検出に有効）。
4. ROM配列化が必要なら `make rom_...` ターゲットを実行。

**デバッグ／検証のヒント**:
- アセンブル後の `*.lst`（例: `min_mon.lst`, `wozmon.lst`, `basic2.lst`）を最初に確認してください。アドレスやラベルのずれ、未解決シンボルはここに現れます。
- 出力バイナリは `bintomon` や既存の `.s9`（`wozmon.s9` など）でフォーマット比較できます。

**追加の注意点**:
- このリポジトリはロー・レベルなROMビルドワークフローです。外部のエミュレータやランナーは含まれていないため、実行検証はユーザ環境（エミュレータ）で行う想定です。
- 既存のMakefileに依存するため、ターゲット名やツールパスをハードコードで変更しないでください。必要があればMakefileを更新してから他ファイルへ変更を伝搬してください。

---
フィードバック: ここに不足している情報、特にローカルのエミュレータ実行手順や依存パス（例: `~/share/cc65/cfg/none.cfg` のような環境依存パス）を追加したい場合は教えてください。修正して反映します。

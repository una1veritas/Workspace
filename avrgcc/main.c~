#include <stdio.h>
#include <avr/io.h>
#include <util/delay.h>

#include "uartprint.h"

#define bitset(r,b) (r |= (1<<(b)))
#define bitclear(r,b) (r &= ~(1<<(b)))

typedef char boolean;
#define true  1
#define false 0
typedef unsigned char byte;
typedef unsigned int  word;

#define D13 5

typedef struct {
  volatile byte * reg;
  byte bp;
} PORTS;

int main(int argc, char * argv[]) {

  PORTS d13mode = { & DDRD, 5 };

  // ports initialized
  //  bitset(DDRD, D13);
  (*d13mode.reg) |= 1<<d13mode.bp;
	// program body
	boolean up = true;
	long wt = 50;
	long full = 160;

	uart_init();
	printf("Hello, world.");
	_delay_ms(100);

loop:
	bitset(PORTB, D13);
	_delay_us(100*wt);
	bitclear(PORTB, D13);
	_delay_us(100*(full-wt));
	if ( up ) wt++; else wt--;
	if ( up && wt >= full ) {
	  up = false;
	} else if ( !up && wt <= 0 ) {
	  up = true;
	}
	goto loop;
	
	return 0;
}


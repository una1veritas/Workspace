\documentclass[11pt,a4,epsf]{report}
%\documentstyle[11pt]{j-article}
%\usepackage{otf}
\usepackage{amssymb}
\usepackage{theorem}
\usepackage{ascmac} %itembox
\usepackage[titletoc,title]{appendix}
%\input{A4}
\setlength{\topmargin}{-1cm}
\setlength{\oddsidemargin}{0cm}
\setlength{\textwidth}{16cm}
\setlength{\textheight}{24cm}
\renewcommand{\@}[1]{{\bf #1}}

\title{{\bf IoT デバイス・プログラミング}}
\author{下薗 真一\\
e-mail: {\sf sin@ai.kyutech.ac.jp}\\
}
%\date{}
%
% 諸定義
%
\def\linesparpage#1{\baselineskip=\textheight\divide\baselineskip#1}
\newtheorem{exerc}{演習}
\newtheorem{adv}{発展課題}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% ワンポイントの表示 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcounter{pntnumber}
\setcounter{pntnumber}{0}
\newcommand{\POINT}[2]{
 \medskip
 \refstepcounter{pntnumber}
\noindent
■■■■■ {\sf Point \arabic{pntnumber}:} {\bf #1} \hrulefill ■ \\
{\small #2}

\noindent
■ \hrulefill ■■■■■ \\
% \begin{center}
%  \fbox{
%   \begin{minipage}{\textwidth}
%    \noindent
%    {\bf ポイント \arabic{pntnumber} (#1)}
%    #2
%   \end{minipage}
%  }
% \end{center}
 \medskip
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% 本文
%
\begin{document}
%\linesparpage{40}
\linesparpage{36}
\maketitle

\medskip

\begin{description}
\item[対象:] 知能情報工学科 2 年次
\item[期間:] 前期
\item[機材:] ？？？CAD実験室(共通教育研究棟 3 階 S303 室)の Linux PC 端末%\\
%	初回のみ 第 I 計算機室(研究棟 6 階)の Linux PC 端末
\end{description}

\medskip

\section{演習の目標}

ワンボード PC である Raspberry Pi をエッジ（末端）デバイスとし，
エッジデバイス上の各種センサーを使った測定，表示出力の使用，
インターネット上のサービスとの連携，などについてプログラミング演習を行う．
IoT とよばれる概念とそこで必要となる技術を習得する．

センサーボードのライブラリによる使用に必要なスクリプト言語 Python にふれる．
プログラミング言語によらない，プログラミングやコンピュータサイエンスの概念を再認識する．

\section{IoT とは}

IoT とは，Internet of the Things （もののインターネット）の略である．
インターネットを，ユーザー（人）が他のユーザーあるいはその集合と情報をやりとりするための空間としてだけではなく，
デバイスや装置が他のデバイス・装置あるいはユーザーとインターネットを通じて情報をやりとりする空間として考えること，
またこれにより実現できるようになる技術やサービスのことを指す．

従来は，デバイスや装置などは，電話回線，無線通信，有線回線などで専用の回線やネットワークを構築し，通信を行うのが主であった．
しかし，有線および無線でのインターネット・インフラが整備され，
機器の基本ソフトウェアとして UNIX 系など TCP/IP による通信が容易な OS が一般的になり，
公開鍵暗号などセキュアな通信経路を確保するための CPU パワーが安価になったことなどから，
機器間，あるいは機器とユーザーの間の接続をインターネットで行い，一般的な回線で多様な機器間で情報をやりとりし，
よりすすんだサービスを提供したり，技術を可能にしようという考え方がひろまってきた．
5G などのより高速で低遅延の無線インターネット回線が実現すれば，ますます発展すると考えられている．

ただし，現状でも直接ユーザーが使用し状況を確認するわけではない膨大な量の機器や装置が，初期設定のままインターネットに接続される状況になっており，
セキュリティ上の脆弱性を悪用され，社会インフラへの攻撃などが起きるのではないか，という懸念が残っている．

\section{Raspberry Pi}

Raspberry Pi ラズベリー・パイは，子供の教育目的にイギリスで設計され世界的に普及しているワンボードＰＣである．
LINUX などを動作させることができる CPU （ARM7相当）とメモリをそなえ，基本ディスク装置として SD カードを使用する．
ビデオ出力（HDMI / アナログビデオ），音声出力，キーボードやマウスを接続できる USB ポート，有線／無線のイーサネットインターフェースを備え，micro USB ポートから電源を供給し，ディスプレイ，キーボードやマウスを接続すれば，
LINUX や組み込み Windows が動作する単体のパソコンとして使用することができる．
また，汎用の I/O ポートやIC間通信のバスが物理的に利用者に開放されており，自作の電子回路や市販のセンサーボードなどハードウェアを追加し使用することができる．

今回は，Sensor Hat  とよばれる，センサ類とスイッチを入力として持ち，マトリクス LED を出力として備える市販のボードを Raspberry Pi にとりつけて演習を行う．


\section{Python 言語}

本演習では，Python 3.x を使用する．

Linux などマルチタスク，マルチユーザーをサポートする OS では，一般に仮想メモリが実装される．
メモリー空間に配置された入出力アドレスへのアクセスには，仮想メモリの影響の排除や他のプロセスのアクセスとの調停が必要になるため，ハードウェアとの通信は，OS の利用を前提としないワンチップ・マイコンより複雑にならざるをえない．
たとえ 1 ビットの読み書きでも，ライブラリを使うことが前提となる．
この実験で使用する Sensor Hat には，使いやすいライブラリが Python 言語で提供されており，入出力やセンサーとの通信プロトコルについては気にせず利用できるようになっている．
そこで，この演習のプログラミングは Python 言語で行う．

Python 言語は，インタープリタで動作する，インデンテーション言語である．
予約語や式，演算子は C言語などに近い．
豊富なライブラリやツールが公開され，それらの追加インストールが容易で，スクリプトの記述から，インターネットでのデータスクレイピング，深層学習によるデータ処理まで，さまざまなデータ処理に使われている．

すでに C 言語を学んでいる場合，Python プログラミングを基礎から体系的に学ぶのはやや冗長である．
今回は Sensor Hat の基本的な使い方を学ぶ中で， C 言語ほか既知のプログラミング言語との相違をふまえる形式で修得する．

\subsection{Python と C の違い，初級編}
%\begin{table}[h]
  \begin{tabular}{|p{1.5in}|p{2in}|p{2in}|}
\hline
文法，記述法 & Python 言語 & C/C++ 言語 \\
\hline
\hline
文の終わり，区切り & 改行 （式の途中でない限りテキスト中の１行が１文） & \verb+;+（セミコロン） \\
\hline
コメント & \verb+#+ の後文末まで & \verb+/*+ から \verb+*/+ の間，\par \verb+//+ の後文末まで \\
\hline
演算子 & インクリメント，デクリメントはない &  \\
\hline
条件分岐 & \verb+if 条件 :+\par ~~~ブロック \par\verb+else:+ \par ~~~ブロック & \verb+if (条件式) +\par ブロック\par\verb+else+\par ブロック \\
\hline
明示的な制御変数を持つループ & \verb+for ... in データのコレクション :+ \par ~~~ブロック& \verb+for (初期化式，条件式，更新式)+ \par ブロック \\
\hline
ループを一度実行した後に条件判断をするループ & なし & \verb+do ... while+ 文\\
\hline
実行ブロック & 文頭からインデント文字数が同じ連続する文 & 一文，または \verb+{+ から \verb+}+ の間\\
\hline
組み込みのデータのコレクションの型 & 組（固定長，変更不可），配列，リスト，辞書，集合，整数範囲 & 配列，構造体（クラス）\\
\hline
データのコレクションの大きさ，要素数 & \verb+len(コレクション)+ & 配列の長さはメモリ割り当て時以外不明，プログラマが管理\\
\hline
  \end{tabular}
%\end{table}

\section{Raspberry Pi の起動からシャットダウン（電源投了）まで}

Raspberry Pi の HDMI ポートと USB ポート，ネットワークポートを使えば，ディスプレイ，キーボード，マウスを接続しインターネットに接続した PC として使用できるが，今回はトラブル等が発生しない限り，ディスプレイおよびキーボードのない状態で起動し，
Wi-Fi を通じて端末エミュレーターで接続し，その中ですべての作業を行う．

\subsection{起動と端末エミュレータからのログイン}

Raspberry Pi には電源スイッチはない．
電源入力である micro USB ポートに，5V/2A の USB電源からケーブルをつないだ時点で起動する．
HDMI やシリアル入出力を通してディスプレイ装置を接続している場合，Linux の起動プロセスメッセージが表示される．
この実験で使用する micro SD カードには， (1)  Wi-Fi 接続を行い，(2) X ウインドウを使用しない状態でログインを待機し，また (3) ネットワークからの SSH 接続を受け入れる設定で Linux (Debian ベースの Raspbian) が起動するようになっている．
SenseHat を装着した状態では，LED マトリクスが消灯したころが起動プロセスが終了したころである．

接続先の Raspberry Pi の IP アドレスが \verb+192.168.1.129+ であるとする．
（実際に使用する IP アドレスは，micro SD カードで OS から設定されるか，ネットワークのアドレスサーバ（DHCP）から割り当てられるので，各自確認すること．）
端末エミュレータからの接続は，セキュアシェル ssh コマンドを使って次のように行う．
\begin{quote}
\small
\begin{verbatim}
$ ssh 192.168.1.129 -l pi
pi@192.168.1.129's password: 

Linux raspberrypi 4.14.98-v7+ #1200 SMP Tue Feb 12 20:27:48 GMT 2019 armv7l
（省略）
pi@raspberrypi:~ $ 
\end{verbatim}
\end{quote}
\verb+pi+ は OS インストール時にデフォルトで設定されるユーザー名で，パスワードは \verb+raspberry+ である．
bash のコマンドプロンプト \verb+pi@raspberrypi:~ $+ で，raspberrypi という名前のホストに ユーザー名 pi でログインしている状態であることがわかる．
\verb+pi+ は管理グループユーザーに設定されているため，管理権限が必要なコマンドも \verb+sudo [コマンド]+ で使用することができる．

\subsection{Python 3 のインタラクティブモードの実行と終了}

Python は，シェルと同様にプログラム・ファイルを実行することができ，インタラクティブ・モードで使うこともできる．
Python 3.x のインタラクティブモードでの起動，対話的実行，終了は，以下のように行う．
実行は，文（改行するまで）ごとに行われる．
\begin{quote}
\small
\begin{verbatim}
pi@raspberrypi:~ $ python3
Python 3.5.3 (default, Sep 27 2018, 17:25:39) 
[GCC 6.3.0 20170516] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> print("Hello, world!")
Hello, world!
>>> pi = 4
>>> sgn = -1
>>> for i in range(1,1000):
...    prev = pi                       # ← ... の後に空白 3 つ
...    pi = pi + 4.0*sgn/(2*i+1)       # 上に同じ
...    sgn = -sgn
... 　                                 # ← ... の後になにも入力せず改行
>>> print(pi)
3.140592653839794
>>> 
>>> quit()
pi@raspberrypi:~ $ 
\end{verbatim}
\end{quote}
\verb+>>>+ はインタプリタのプロンプトである．
\verb+...+ は，改行したがまだループのネストの中にあり，最も外側の文が終わっていないことを示しているので，ネストのレベルにあわせた適切な量の空白やタブを入れインデントづけする．
上の例では，\verb+for in range(1,1000) :+ で変数 \verb+i+ に範囲 $[1,1000)$ から順に一つずつ整数を代入し，
その次の同じインデントを持つ 4行をくりかえす．
インタラクティブモードでは，ループの中のブロックが終了したことを伝えるため，\verb+...+ のあとをカラのまま改行して， \verb+for+ の文を終わらせる．

Python のインタラクティブモードを終了するには，関数 \verb+quit()+ を実行する．

\subsection{シャットダウンと終了}

Raspberry Pi の電源を切る場合，OS のシャットダウンを使用してから micro USB ケーブルを抜く．
\begin{quote}
\small
\begin{verbatim}
pi@raspberrypi:~ $ sudo shutdown now
Connection to 192.168.1.129 closed by remote host.
Connection to 1192.168.1.129 closed.
$ 
\end{verbatim}
\end{quote}
接続が切られてからしばらくすると，LED の点滅をしなくなるので，ケーブルを抜いて終了である．
ただしディスクアクセス中などでなければ，突然電源を OFF にしてもファイルやディレクトリが壊れたり，起動しなくなる，といった状態になることはまれである．

\section{Sensor Hat の基本的な使い方}

\subsection{LED マトリクスによるテキストの流れ表示}

Python のインタラクティブモードで，Sensor Hat の LED マトリクス表示装置を使用してみよう．
\begin{quote}
\small
\begin{verbatim}
pi@raspberrypi:~ $ python3
Python 3.5.3 (default, Sep 27 2018, 17:25:39) 
[GCC 6.3.0 20170516] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from sense_hat import SenseHat        # SenseHat クラスライブラリの使用を宣言
>>> sense = SenseHat()                    # SenseHat へのアクセスオブジェクトを生成
>>> sense.show_message("hello, world!")   # LED Matrix に文字列を流れ出力
>>> 
\end{verbatim}
\end{quote}

\begin{excercise}
流れるスピード，文字の色，背景の色が設定／変更できるので，\verb+show_message+ 関数の引数を Web ページ\footnote{Google 等で検索しなさい．たとえば {\tt https://pythonhosted.org/sense-hat/api/} など}でしらべ，メッセージや色を変えてみよう．
\end{excercise}

\subsection{慣性計測センサ（IMU）}

SenseHat には，マイクロマシン技術を使った超小型の一体型加速度，ジャイロ（回転），磁気のセンサが搭載されている．
これらのセンサの普及によって，手ぶれ防止やドローンの自動制御，スマートホンの万歩計機能や地図の方位機能が使用可能になった．
\begin{quote}
\small
\begin{verbatim}
>>> rad = sense.get_orientation_radians()
>>> print("p: {pitch}, r: {roll}, y: {yaw}".format(**rad))   #←これはとりあえず呪文
p: 0.0, r: 0.0, y: 0.0
>>> print(sense.orientation_radians)
{'pitch': 0.8420565724372864, 'roll': 0.6746504306793213, 'yaw': 1.0145331621170044}
>>> print(sense.orientation_radians)      #立てたり，向きを変えて実行
{'pitch': 0.8724074959754944, 'roll': 1.4002370834350586, 'yaw': 1.868024230003357}
>>> print(sense.orientation_radians)      #また向きを変えて実行
{'pitch': -0.06325805932283401, 'roll': 1.4057660102844238, 'yaw': 1.428795337677002}
>>> 
\end{verbatim}
\end{quote}
\verb+{ キー1 : 値, キー2 : 値, ... }+ は，辞書データ構造である．
Python ではリスト，組，集合などと同様に，組み込みで使用できる．
文字列は \verb+' '+でくくることもできる．

\begin{excercise}
傾きを \verb+show_message+ を使ってデバイスの LED Matrix 上で表示させてみなさい．
\end{excercise}

\subsection{気温，湿度，気圧センサ}

次に，気候に関するセンサーの値を利用する Python のプログラムを作成してみよう．
以下の内容のテキスト・ファイルを Raspberry Pi で作成し，たとえば \verb+sensehat.py+ として（Raspberry Pi のディレクトリに）保存する．
エディタは Raspbian に標準でインストールされている \verb+nano+，または 追加インストールされている \verb+emacs+ を使用するとよい．
\verb+nano+ は使用するコマンド（保存，終了など）がスクリーン下にメニュー形式で表示される．
保存するファイル名は毎回プロンプトされるので，修正の必要がなければそのまま改行する．
 \begin{itembox}[l]{\tt sensehat.py}
\begin{quote}
\small
\begin{verbatim}
from sense_hat import SenseHat

sense = SenseHat()

temp = sense.get_temperature()
humi = sense.get_humidity()
pres = sense.get_pressure()

print("T = "+str(temp)+" deg., H = "+str(humi)+" %, P = "+str(pres)+" hPa")
\end{verbatim}
\end{quote}
\end{itembox}

Python プログラム・ファイルは，コマンド \verb+python3 [ファイル名] [引数]+ で実行する．
\verb+sensehat.py+ は引数を使わないので，実行例は以下のようになる．
\begin{quote}
\small
\begin{verbatim}
pi@raspberrypi:~/Documents $ python3 sensehat.py 
T = 34.04765701293945 deg., H = 31.003049850463867 %, P = 1010.461181640625 hPa
pi@raspberrypi:~/Documents $ 
\end{verbatim}
\end{quote}

\end{document}



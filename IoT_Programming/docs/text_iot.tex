\documentclass[11pt,a4,epsf]{report}
%\documentstyle[11pt]{j-article}
%\usepackage{otf}
\usepackage{amssymb}
\usepackage{theorem}
\usepackage[titletoc,title]{appendix}
%\input{A4}
\setlength{\topmargin}{-1cm}
\setlength{\oddsidemargin}{0cm}
\setlength{\textwidth}{16cm}
\setlength{\textheight}{24cm}
\renewcommand{\@}[1]{{\bf #1}}

\title{{\bf IoT デバイス・プログラミング}}
\author{下薗 真一\\
e-mail: {\sf sin@ai.kyutech.ac.jp}\\
}
%\date{}
%
% 諸定義
%
\def\linesparpage#1{\baselineskip=\textheight\divide\baselineskip#1}
\newtheorem{exerc}{演習}
\newtheorem{adv}{発展課題}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% ワンポイントの表示 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcounter{pntnumber}
\setcounter{pntnumber}{0}
\newcommand{\POINT}[2]{
 \medskip
 \refstepcounter{pntnumber}
\noindent
■■■■■ {\sf Point \arabic{pntnumber}:} {\bf #1} \hrulefill ■ \\
{\small #2}

\noindent
■ \hrulefill ■■■■■ \\
% \begin{center}
%  \fbox{
%   \begin{minipage}{\textwidth}
%    \noindent
%    {\bf ポイント \arabic{pntnumber} (#1)}
%    #2
%   \end{minipage}
%  }
% \end{center}
 \medskip
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% 本文
%
\begin{document}
%\linesparpage{40}
\linesparpage{36}
\maketitle

\medskip

\begin{description}
\item[対象:] 知能情報工学科 2 年次
\item[期間:] 前期
\item[機材:] ？？？CAD実験室(共通教育研究棟 3 階 S303 室)の Linux PC 端末%\\
%	初回のみ 第 I 計算機室(研究棟 6 階)の Linux PC 端末
\end{description}

\medskip

\section{演習の目標}

ワンボード PC である Raspberry Pi をエッジデバイスとし，
エッジデバイス上の各種センサーを使った測定，表示出力の使用，
インターネット上のサービスとの連携，などについてプログラミング演習を行う．
IoT とよばれる概念とそこで必要となる技術を習得する．

センサーボードのライブラリによる使用に必要なスクリプト言語 Python にふれる．
プログラミング言語によらない，プログラミングやコンピュータサイエンスの概念を再認識する．

\section{IoT とは}

IoT とは，Internet of the Things （もののインターネット）を略したものである．
人間がユーザーとして他のユーザーとの情報のやりとりを目的に使用するインターネットの活用とはことなる，
デバイスや装置が直接他のデバイス・装置あるいはユーザーとインターネットを通じて情報をやりとりすることで可能になる，
技術やサービスのことである．

従来は，デバイスや装置などは，電話回線，無線通信，有線回線などで専用の回線やネットワークを構築し，通信を行ってきた．
しかし，優先および無線でのインターネットの普及，機器の基本ソフトウェアで UNIX 系など TCP/IP による通信が容易な OS が使われるようになったこと，公開鍵暗号などでセキュアな通信経路を確保できるようになったことなどから，
機器間，あるいは機器とユーザーの間の接続をインターネットで行い，一般的な回線で多様な機器間で情報をやりとりし，
よりすすんだサービスを提供したり，技術を可能にしようという考え方がひろまってきた．
5G などのより高速で低遅延のインターネット回線が実現すれば，ますます発展すると考えられている．

ただし，直接ユーザーが使用し状況を確認するわけではない膨大な量の機器や装置が，初期設定のままインターネットに接続される状況になっており，
セキュリティ上の脆弱性を悪用され，インターネットなど社会インフラへの攻撃などが起きるのではないか，という懸念が残っている．

\section{Raspberry Pi}

ラズベリー・パイは，イギリスで子供の教育目的に設計されたワンボードＰＣである．
LINUX などを動作させることができる CPU とメモリをそなえ，基本ディスク装置として SD カードを使用する．
ビデオ出力（HDMI / アナログビデオ），音声出力，キーボードやマウスを接続できる USB ポート，有線／無線のイーサネットインターフェースを備えている．
micro USB ポートから電源を供給し，ディスプレイ，キーボードやマウスを接続すれば，LINUX や組み込み Windows が動作するパソコンとして使用することができる．
また，汎用の I/O ポートやIC間通信のバスが利用可能で，自作の電子回路や市販のセンサーボードなどハードウェアを追加し使用することができる．

今回は，Sensor Hat  とよばれる，センサ類とスイッチを入力として持ち，マトリクス LED を出力として備える市販のボードを Raspberry Pi につけて演習を行う．


\section{Python 言語}

本演習では，Python 3.x を使用する．

Linux などマルチタスク，マルチユーザーをサポートする OS では，一般に仮想メモリが実装される．
メモリー空間に配置された入出力アドレスへのアクセスには，仮想メモリの影響の排除や他のプロセスのアクセスとの調停が必要になるため，追加したセンサー類との通信は，OS の利用を前提としないワンチップ・マイコンより複雑にならざるをえない．
たとえ 1 ビットの読み書きでも，ライブラリを使うことが前提となる．
この実験で使用する Sensor Hat には，使いやすいライブラリが Python 言語で提供されており，入出力については考えなくてよいようになっている．
そこで，この演習のプログラミングは Python 言語で行う．

Python 言語は，インタープリタで動作する，インデンテーション言語である．
予約語や式，演算子は C言語などに近い．
豊富なライブラリやツールが公開され，それらの追加インストールが容易で，スクリプトの記述から，インターネットでのデータスクレイピング，深層学習によるデータ処理まで，さまざまなデータ処理に使われている．

すでに C 言語を学んでいる場合，Python プログラミングを基礎から体系的に学ぶのは冗長であるため，今回は主に Sensor Hat の基本的な使い方をみていく中で，既知のプログラミング言語との相違をふまえて修得してほしい．

\section{Raspberry Pi の起動とシャットダウン}

Raspberry Pi の HDMI ポートと USB ポート，ネットワークポートを使えば，ディスプレイ，キーボード，マウスを接続しインターネットに接続した PC として使用できるが，今回はトラブル等が発生しない限り，ディスプレイの無い状態で起動，Wi-Fi を通じて端末エミュレーターを接続し，その中でコマンドの実行やファイルの編集を行うものとする．

\subsection{起動と端末エミュレータからのログイン}

Raspberry Pi には電源スイッチはない．
電源入力である micro USB ポートに，5V/2A の電源からケーブルをつないで起動する．
HDMI やシリアル入出力を通してディスプレイ装置を接続している場合，Linux の起動プロセスメッセージが表示される．
この実験で使用する micro SD カードには， (1)  Wi-Fi 接続を行い，(2) X ウインドウを使用しない状態でログインを待機し，また (3) ネットワークからの SSH 接続を受け入れる設定で Linux (Debian ベースの Raspbian) が起動するようになっている．

接続先の Raspberry Pi の IP アドレスが \verb+192.168.1.129+ であるとする．
（実際に使用する IP アドレスは，micro SD カードで OS から設定されるか，ネットワークのアドレスサーバ（DHCP）から割り当てられるので，各自確認すること．）
端末エミュレータからの接続は，セキュアシェル ssh コマンドを使って次のように行う．
\begin{quote}
\small
\begin{verbatim}
$ ssh 192.168.1.129 -l pi
pi@192.168.1.129's password: 

Linux raspberrypi 4.14.98-v7+ #1200 SMP Tue Feb 12 20:27:48 GMT 2019 armv7l
（省略）
pi@raspberrypi:~ $ 
\end{verbatim}
\end{quote}
\verb+pi+ はデフォルトで設定されるユーザー名で，パスワードは \verb+raspberry+ である．
bash のコマンドプロンプト \verb+pi@raspberrypi:~ $+ で，Raspberry Pi に ユーザー名 pi でログインしている状態であることがわかる．

\subsection{Python 3 のインタラクティブモードの実行と終了}

Python は，シェルのようにプログラムを実行することができ，またインタラクティブモードで使うこともできる．
Python 3.x のインタラクティブモードでの起動，対話的実行，終了は，以下のように行う．
実行は，文（改行するまで）ごとに行われる．
\begin{quote}
\small
\begin{verbatim}
pi@raspberrypi:~ $ python3
Python 3.5.3 (default, Sep 27 2018, 17:25:39) 
[GCC 6.3.0 20170516] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> print("Hello, world!")
Hello, world!
>>> sum = 4.0
>>> sign = -1
>>> for i in range(1,1000):
...    prev = sum
...    sum = sum + 4.0*sign/(2*i + 1)
...    sign = -sign
... 
>>> print(sum)
3.140592653839794
>>> 
\end{verbatim}
\end{quote}
\verb+>>>+ はインタプリタのプロンプトである．
\verb+...+ は，改行したがまだループのネストの中にあり，最も外側の文が終わっていないことを示しているので，ネストのレベルにあわせた適切な量の空白やタブを入れインデントづけする．

Python のインタラクティブモードを終了するには，関数 \verb+quit()+ を実行する．
\begin{quote}
\begin{verbatim}
>>> quit()
pi@raspberrypi:~ $ 
\end{verbatim}
\end{quote}

\subsection{シャットダウンと終了}

Raspberry Pi の電源を切る場合，OS のシャットダウンを使用してから micro USB ケーブルを抜く．
\begin{verbatim}
pi@raspberrypi:~ $ sudo shutdown now
Connection to 192.168.1.129 closed by remote host.
Connection to 1192.168.1.129 closed.
$ 
\end{verbatim}
接続が切られてからしばらくすると，LED の点滅をしなくなるので，ケーブルを抜いて終了である．
ただし，ディスクアクセス中などでなければ，突然電源を OFF にしてもファイルやディレクトリが壊れたり，起動しなくなる，といった状態になることは，まれである．

\section{Sensor Hat の基本的な使い方}

\subsection{LED マトリクスによるテキストの流れ表示}

Python のインタラクティブモードで，Sensor Hat の LED マトリクス表示装置を使用してみよう．
\begin{quote}
\small
\begin{verbatim}
pi@raspberrypi:~ $ python3
Python 3.5.3 (default, Sep 27 2018, 17:25:39) 
[GCC 6.3.0 20170516] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from sense_hat import SenseHat        # SenseHat クラスライブラリの使用を宣言
>>> sense = SenseHat()                    # SenseHat へのアクセスオブジェクトを生成
>>> sense.show_message("hello, world!")   # LED Matrix に文字列を流れ出力
>>> 
\end{verbatim}
\end{quote}

\begin{excercise}
流れるスピード，文字の色，背景の色が設定／変更できるので，\verb+show_message+ 関数の引数を Web ページ\footnote{Google 等で検索しなさい．たとえば {\tt https://pythonhosted.org/sense-hat/api/} など}でしらべ，メッセージや色を変えてみよう．
\end{excercise}

\subsection{慣性計測センサ（IMU）}

SenseHat には，マイクロマシン技術を使った超小型の一体型加速度，ジャイロ（回転），磁気のセンサが搭載されている．
これらのセンサの普及によって，手ぶれ防止やドローンの自動制御，スマートホンの万歩計機能や地図の方位機能が使用可能になった．
\begin{quote}
\small
\begin{verbatim}
>>> rad = sense.get_orientation_radians()
>>> print("p: {pitch}, r: {roll}, y: {yaw}".format(**rad))   #←これは呪文と思ってスルーしよう．
p: 0.0, r: 0.0, y: 0.0
>>> print(sense.orientation_radians)
{'pitch': 0.8420565724372864, 'roll': 0.6746504306793213, 'yaw': 1.0145331621170044}
>>> print(sense.orientation_radians)      #立てたり，向きを変えて実行
{'pitch': 0.8724074959754944, 'roll': 1.4002370834350586, 'yaw': 1.868024230003357}
>>> print(sense.orientation_radians)      #また向きを変えて実行
{'pitch': -0.06325805932283401, 'roll': 1.4057660102844238, 'yaw': 1.428795337677002}
>>> 
\end{verbatim}
\end{quote}

\begin{excercise}
傾きを \verb+show_message+ で表示させてみなさい．
\end{excercise}

\end{document}


